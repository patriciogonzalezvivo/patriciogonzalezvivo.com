!function(){"use strict";function e(e,t){return new THREE.ShaderMaterial({uniforms:void 0===t?{}:t,vertexShader:"varying vec2 v_texcoord;\n    void main() {\n        v_texcoord = uv;\n        gl_Position = vec4(position, 1.0);\n    }",fragmentShader:e})}var t=Math.floor;const r=Math.pow(2,-32),n=32557,i=19605,s=new Uint16Array(4),a=new DataView(s.buffer),c=(e,t=0)=>{const r=16,n=65535,i=255;for(var s,a=1540483477,c=e.length,o=t^c,v=0;4<=c;)s=((s=e[v]&i|(e[++v]&i)<<8|(e[++v]&i)<<16|(e[++v]&i)<<24)&n)*a+(((s>>>r)*a&n)<<r),o=(o&n)*a+(((o>>>r)*a&n)<<r)^(s=((s^=s>>>24)&n)*a+(((s>>>r)*a&n)<<r)),c-=4,++v;switch(c){case 3:o^=(e[v+2]&i)<<r;case 2:o^=(e[v+1]&i)<<8;case 1:o=((o^=e[v]&i)&n)*a+(((o>>>r)*a&n)<<r)}return o=((o^=o>>>13)&n)*a+(((o>>>16)*a&n)<<16),(o^=o>>>15)>>>0},o=(e,t)=>(void 0===t&&(t=e,e=0),(()=>{const e=s[0],t=s[1],a=s[2],c=s[3],o=0|33103+n*e,v=0|63335+n*t+(i*e+(o>>>16)),f=0|31614+n*a+i*t+(62509*e+(v>>>16));s[0]=o,s[1]=v,s[2]=f,s[3]=5125+n*c+(i*a+62509*t)+(22609*e+(f>>>16));const l=(c<<21)+((c>>2^a)<<5)+((a>>2^t)>>11);return r*((l>>>(c>>11)|l<<(31&-(c>>11)))>>>0)})()*(t-e)+e),v=e=>{return e.length?e[(r=e.length,t(o(r,void 0)))]:void 0;var r};class f{constructor(t,r={}){if(!t.capabilities.floatFragmentTextures)throw new Error("No OES_texture_float support for float textures.");this.renderer=t,this.defines={},this.uniforms=r,this.uniforms.u_camera={value:new THREE.Vector3},this.uniforms.u_viewMatrix={value:null},this.uniforms.u_projectionMatrix={value:null},this.uniforms.u_resolution={value:new THREE.Vector2},this.uniforms.u_delta={value:0},this.uniforms.u_time={value:0},this.uniforms.u_frame={value:0},this.buffers=[],this.doubleBuffers=[],this.background=null,this.main=null,this.sceneBuffer=null,this.postprocessing=null,this.billboard_scene=new THREE.Scene,this.billboard_camera=new THREE.Camera,this.billboard_camera.position.z=1,this.passThruUniforms={texture:{value:null}},this.passThruShader=e("uniform sampler2D texture;\n    uniform vec2 u_resolution;\n    void main() {\n        vec2 uv = gl_FragCoord.xy / u_resolution.xy;\n        gl_FragColor = texture2D( texture, uv );\n    }",this.passThruUniforms),this.mesh=new THREE.Mesh(new THREE.PlaneGeometry(2,2),this.passThruShader),this.billboard_scene.add(this.mesh),this.clock=new THREE.Clock,this.frame=0,this.lastTime=0,this.time=0,this.resolution=new THREE.Vector2(t.domElement.width,t.domElement.height)}getBufferSize(e,t){const r=new RegExp(`uniform\\s*sampler2D\\s*${t}\\;\\s*\\/\\/*\\s(\\d+)x(\\d+)`,"gm").exec(e);if(r)return{width:parseInt(r[1]),height:parseInt(r[2])};const n=new RegExp(`uniform\\s*sampler2D\\s*${t}\\;\\s*\\/\\/*\\s(\\d*\\.\\d+|\\d+)`,"gm").exec(e);if(n){if(2<n.length)return{width:parseFloat(n[1]),height:parseFloat(n[2])};if(1<n.length)return{width:parseFloat(n[1]),height:parseFloat(n[1])}}return{width:1,height:1}}load(t){t.match(/(?:^\s*)((?:#if|#elif)(?:\s*)(defined\s*\(\s*BACKGROUND)(?:\s*\))|(?:#ifdef)(?:\s*BACKGROUND)(?:\s*))/gm)&&(this.renderer.autoClearColor=!1,this.addBackground(t));const r=t.match(/(?:^\s*)((?:#if|#elif)(?:\s*)(defined\s*\(\s*BUFFER_)(\d+)(?:\s*\))|(?:#ifdef)(?:\s*BUFFER_)(\d+)(?:\s*))/gm);if(r)for(let e,n=0;n<r.length;n++)e=this.getBufferSize(t,`u_buffer${n}`),this.addBuffer(t,e.width,e.height);const n=t.match(/(?:^\s*)((?:#if|#elif)(?:\s*)(defined\s*\(\s*DOUBLE_BUFFER_)(\d+)(?:\s*\))|(?:#ifdef)(?:\s*DOUBLE_BUFFER_)(\d+)(?:\s*))/gm);if(n){this.renderer.autoClearColor=!1;for(let e,r=0;r<n.length;r++)e=this.getBufferSize(t,`u_doubleBuffer${r}`),this.addDoubleBuffer(t,e.width,e.height)}this.main=e(t,this.uniforms),t.match(/(?:^\s*)((?:#if|#elif)(?:\s*)(defined\s*\(\s*POSTPROCESSING)(?:\s*\))|(?:#ifdef)(?:\s*POSTPROCESSING)(?:\s*))/gm)&&this.addPostprocessing(t)}addBackground(t){return this.background=e(`#define BACKGROUND\n${t}`,this.uniforms),this.background.defines=this.defines,this.background}addBuffer(t,r,n){let i=this.buffers.length,s=e(`#define BUFFER_${i}\n${t}`,this.uniforms);s.defines=this.defines;let a={name:`u_buffer${i}`,material:s,renderTarget:null,width:r,height:n,wrapS:THREE.RepeatWrapping,wrapT:THREE.RepeatWrapping,minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter};return this.buffers.push(a),this.uniforms[a.name]={value:null},a.renderTarget=this.createRenderTarget(a),a}addDoubleBuffer(t,r,n){let i=this.doubleBuffers.length,s=e(`#define DOUBLE_BUFFER_${i}\n${t}`,this.uniforms);s.defines=this.defines;let a={name:`u_doubleBuffer${i}`,material:s,renderTargets:[],width:r,height:n,wrapS:THREE.RepeatWrapping,wrapT:THREE.RepeatWrapping,minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter};return this.doubleBuffers.push(a),this.uniforms[a.name]={value:null},a.renderTargets[0]=this.createRenderTarget(a),a.renderTargets[1]=this.createRenderTarget(a),a}addPostprocessing(t){return this.postprocessing=e(`#define POSTPROCESSING\n${t}`,this.uniforms),this.postprocessing.defines=this.defines,this.sceneBuffer={renderTarget:null,width:this.renderer.domElement.width,height:this.renderer.domElement.height},this.uniforms.u_scene={value:null},this.sceneBuffer.renderTarget=this.createRenderTarget({width:this.sceneBuffer.width,height:this.sceneBuffer.height,wrapS:null,wrapT:null,minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter}),this.sceneBuffer}createRenderTarget(e){e.wrapS=e.wrapS||THREE.ClampToEdgeWrapping,e.wrapT=e.wrapT||THREE.ClampToEdgeWrapping,e.minFilter=e.minFilter||THREE.NearestFilter,e.magFilter=e.magFilter||THREE.NearestFilter;let r=THREE.FloatType;!1===this.renderer.capabilities.isWebGL2&&(r=THREE.HalfFloatType);let n=e.width,i=e.height;return 1>=n&&1>=i&&(n*=this.renderer.domElement.width,i*=this.renderer.domElement.height),new THREE.WebGLRenderTarget(t(n),t(i),{wrapS:e.wrapS,wrapT:e.wrapT,minFilter:e.minFilter,magFilter:e.magFilter,format:THREE.RGBAFormat,type:/(iPad|iPhone|iPod)/g.test(navigator.userAgent)?THREE.HalfFloatType:r,stencilBuffer:!1})}updateUniforms(e=null){this.time=this.clock.getElapsedTime(),this.uniforms.u_time.value=this.time,this.uniforms.u_delta.value=this.time-this.lastTime,this.uniforms.u_frame.value=this.frame,e&&(this.uniforms.u_camera.value=e.position,this.uniforms.u_projectionMatrix.value=e.projectionMatrix,this.uniforms.u_viewMatrix.value=e.matrixWorldInverse),this.lastTime=this.time,this.frame++}updateBuffers(){for(let e,r=0,n=this.buffers.length;r<n;r++)e=this.buffers[r],this.uniforms.u_resolution.value=1>=e.width&&1>=e.height?new THREE.Vector2(t(this.resolution.x*e.width),t(this.resolution.y*e.height)):new THREE.Vector2(e.width,e.height),this.renderTarget(e.material,e.renderTarget),this.uniforms[e.name].value=e.renderTarget.texture;let e=this.frame%2,r=(this.frame+1)%2;for(let n,i=0,s=this.doubleBuffers.length;i<s;i++)n=this.doubleBuffers[i],this.uniforms.u_resolution.value=1>=n.width&&1>=n.height?new THREE.Vector2(t(this.resolution.x*n.width),t(this.resolution.y*n.height)):new THREE.Vector2(n.width,n.height),this.uniforms[n.name].value=n.renderTargets[e].texture,this.renderTarget(n.material,n.renderTargets[r]);this.renderer.setRenderTarget(null)}renderBackground(){this.background&&(this.mesh.material=this.background,this.renderer.render(this.billboard_scene,this.billboard_camera),this.mesh.material=this.passThruShader)}getBufferTexture(e){return e>=this.buffers.length?void 0:this.buffers[e].renderTarget.texture}getDoubleBufferTexture(e){return e>=this.doubleBuffers.length?void 0:this.doubleBuffers[e].renderTargets[this.frame%2].texture}renderBuffer(e){e>=this.buffers.length||(this.uniforms.u_resolution.value=this.resolution,this.passThruUniforms.texture.value=this.geBufferTexture(e),this.mesh.material=this.passThruShader,this.renderer.render(this.billboard_scene,this.billboard_camera))}renderDoubleBuffer(e){e>=this.doubleBuffers.length||(this.uniforms.u_resolution.value=this.resolution,this.passThruUniforms.texture.value=this.getDoubleBufferTexture(e),this.mesh.material=this.passThruShader,this.renderer.render(this.billboard_scene,this.billboard_camera))}renderMain(){this.updateUniforms(),this.updateBuffers(),this.uniforms.u_resolution.value=this.resolution,this.mesh.material=this.material,this.renderer.render(this.billboard_scene,this.billboard_camera),this.mesh.material=this.passThruShader}renderScene(e,t){this.updateUniforms(t),this.updateBuffers(),this.uniforms.u_resolution.value=this.resolution,this.uniforms.u_camera.value=t.position,this.sceneBuffer&&(this.renderer.setRenderTarget(this.sceneBuffer.renderTarget),this.renderer.clear()),this.renderBackground(),this.renderer.render(e,t),this.sceneBuffer&&(this.renderer.setRenderTarget(null),this.renderer.clear(),this.uniforms.u_resolution.value=this.resolution,this.uniforms.u_scene.value=this.sceneBuffer.renderTarget.texture,this.mesh.material=this.postprocessing,this.renderer.render(this.billboard_scene,this.billboard_camera),this.mesh.material=this.passThruShader)}renderTarget(e,t){this.mesh.material=e,this.renderer.setRenderTarget(t),this.renderer.clear(),this.renderer.render(this.billboard_scene,this.billboard_camera,t),this.mesh.material=this.passThruShader}setSize(e,r){e*=window.devicePixelRatio,r*=window.devicePixelRatio,this.sceneBuffer&&(this.sceneBuffer.width=e,this.sceneBuffer.height=r,this.sceneBuffer.renderTarget.setSize(e,r)),this.resolution=new THREE.Vector2(e,r),this.uniforms.u_resolution.value=this.resolution;for(let t,n=0;n<this.buffers.length;n++)t=this.buffers[n],1>=t.width&&1>=t.height&&t.renderTarget.setSize(t.width*e,t.height*r);for(let n=0;n<this.doubleBuffers.length;n++){this.renderer.autoClearColor=!1;let i=this.doubleBuffers[n];if(1>=i.width&&1>=i.height){let n=t(i.width*e),s=t(i.height*r);i.renderTargets[0].setSize(n,s),i.renderTargets[1].setSize(n,s)}}this.frame=0}}const l={defines:{BUBBLE_ELEVATION:[.001,.4],BUBBLE_SHIFT:[-.9,-.5,0,0,0,0,.5,.9],TIME_OFFSET:[.001,100],SIMULATION_SPEED:[.6,1],INTERFERENCE_IOR:[.85,1],INTERFERENCE_SCALE:[10,30],INTERFERENCE_GAMMA_SCALE:[.3,1],INTERFERENCE_FRESNEL_RATIO:[.7,.8],INTERFERENCE_DISPERSION:[.001,.1],INTERFERENCE_THICKNESS_SCALE:[30,42.5],ATMOSPHERE_INTENSITY:[.9,1],ATMOSPHERE_SUN_POWER:[8,15],ATMOSPHERE_ELEVATION:[.25,.9],ATMOSPHERE_FAST:[0,0,0,0,1],GROUND_INTENSITY:[.5,1],GROUND_HUE:[.001,1],EQUIRECT_ANGLE:[-3.1415,3.1415],EQUIRECT_TILT:[-3.1415,3.1415],STREAM_INTENSITY:[0,.45],STREAM_TYPE:[0,1],STREAM_AMOUNT:[.15,.3],STREAM_GRID_X:[75,200],STREAM_GRID_Y:[50,200],STREAM_SPEED:[.25,2],FIELD_GRID:[50,80],FIELD_SPEED:[.25,.9],FIELD_INTENSITY:[.2,.3],LIGHT_FLARE_INTENSITY:[.001,3]},filter:[["STREAM_INTENSITY","STREAM_INTENSITY","FIELD_INTENSITY"]]},u="\nvec2 srandom2(vec2 v){const vec2 f=vec2(.3183099,.3678794);v=v*f+f.yx;return-1.+2.*fract(16.*f*fract(v.x*v.y*(v.x+v.y)));}\nvec3 srandom3(vec3 v){v=vec3(dot(v,vec3(127.1,311.7,74.7)),dot(v,vec3(269.5,183.3,246.1)),dot(v,vec3(113.5,271.9,124.6)));return-1.+2.*fract(sin(v)*43758.5453123);}\nvec3 noised(vec2 v){vec2 f=floor(v),x=fract(v),c=x*x*x*(x*(x*6.-15.)+10.),S=srandom2(f+vec2(0)),s=srandom2(f+vec2(1,0)),y=srandom2(f+vec2(0,1)),I=srandom2(f+vec2(1));float A=dot(S,x-vec2(0)),d=dot(s,x-vec2(1,0)),T=dot(y,x-vec2(0,1)),U=dot(I,x-vec2(1));return vec3(A+c.x*(d-A)+c.y*(T-A)+c.x*c.y*(A-d-T+U),S+c.x*(s-S)+c.y*(y-S)+c.x*c.y*(S-s-y+I)+30.*x*x*(x*(x-2.)+1.)*(c.yx*(A-d-T+U)+vec2(d,T)-A));}vec4 noised(vec3 v){vec3 f=floor(v),x=fract(v),c=x*x*x*(x*(x*6.-15.)+10.),S=srandom3(f+vec3(0)),s=srandom3(f+vec3(1,0,0)),y=srandom3(f+vec3(0,1,0)),I=srandom3(f+vec3(1,1,0)),d=srandom3(f+vec3(0,0,1)),T=srandom3(f+vec3(1,0,1)),A=srandom3(f+vec3(0,1,1)),U=srandom3(f+vec3(1));float r=dot(S,x-vec3(0)),z=dot(s,x-vec3(1,0,0)),i=dot(y,x-vec3(0,1,0)),p=dot(I,x-vec3(1,1,0)),u=dot(d,x-vec3(0,0,1)),V=dot(T,x-vec3(1,0,1)),R=dot(A,x-vec3(0,1,1)),Y=dot(U,x-vec3(1));return vec4(r+c.x*(z-r)+c.y*(i-r)+c.z*(u-r)+c.x*c.y*(r-z-i+p)+c.y*c.z*(r-i-u+R)+c.z*c.x*(r-z-u+V)+(-r+z+i-p+u-V-R+Y)*c.x*c.y*c.z,S+c.x*(s-S)+c.y*(y-S)+c.z*(d-S)+c.x*c.y*(S-s-y+I)+c.y*c.z*(S-y-d+A)+c.z*c.x*(S-s-d+T)+(-S+s+y-I+d-T-A+U)*c.x*c.y*c.z+30.*x*x*(x*(x-2.)+1.)*(vec3(z,i,u)-r+c.yzx*vec3(r-z-i+p,r-i-u+R,r-z-u+V)+c.zxy*vec3(r-z-u+V,r-z-i+p,r-i-u+R)+c.yzx*c.zxy*(-r+z+i-p+u-V-R+Y)));}\n",d="\nuniform sampler2D   u_scene; \nuniform sampler2D   u_buffer0; // 512x512\nuniform sampler2D   u_doubleBuffer0; // 512x512\nuniform mat4        u_viewMatrix;\nuniform mat4        u_projectionMatrix;\nuniform vec3        u_camera;\nuniform vec3        u_light;\nuniform vec2        u_resolution;\nuniform float       u_time;\nuniform int         u_frame;\nvarying vec4        v_position;\n#ifdef MODEL_VERTEX_NORMAL\nvarying vec3 v_normal;\n#endif\nvarying vec2 v_texcoord;\n#define TAU 6.2831853071795864769252867665590\n#define PI 3.1415926535897932384626433832795\n#define HALF_PI 1.5707963267948966192313216916398\n//\n#ifndef STREAM_TYPE\n#define STREAM_TYPE 0.0\n#endif\n#define LIGHT_POSITION normalize(u_camera * vec3(1.0, 0.0, 1.0) + vec3(sin(TIME_OFFSET + u_time * 0.2), sin(TIME_OFFSET + u_time * 0.13) * 0.3 + 0.5, cos( TIME_OFFSET + u_time * 0.14)))\n#define decimate(V,P)(floor(V*P)/P)\nmat3 rotate3dX(float v){return mat3(vec3(1,0,0),vec3(0,cos(v),-sin(v)),vec3(0,sin(v),cos(v)));}mat3 rotate3dZ(float v){return mat3(vec3(cos(v),-sin(v),0),vec3(sin(v),cos(v),0),vec3(0,0,1));}vec2 ratio(vec2 v,vec2 f){return mix(vec2(v.x*f.x/f.y-(f.x*.5-f.y*.5)/f.y,v.y),vec2(v.x,v.y*(f.y/f.x)-(f.y*.5-f.x*.5)/f.x),step(f.x,f.y));}vec2 scale(float v,float I,vec2 s){return(v-s)*I+s;}vec2 scale(float v,float f){return scale(v,f,vec2(.5));}vec2 scale(vec2 v,vec2 I,vec2 s){return(v-s)*I+s;}vec2 scale(vec2 v,float s,vec2 f){return scale(v,vec2(s),f);}vec2 scale(vec2 v,vec2 I){return(v-.5)*I+.5;}vec2 scale(vec2 v,float I){return(v-.5)*I+.5;}vec3 scale(vec3 v,vec3 I,vec3 s){return(v-s)*I+s;}vec3 scale(vec3 v,float I,vec3 s){return(v-s)*I+s;}vec3 scale(vec3 v,vec3 I){return(v-.5)*I+.5;}vec3 scale(vec3 v,float I){return(v-.5)*I+.5;}vec4 scale(vec4 v,float f){return vec4(scale(v.xy,f),v.zw);}vec4 scale(vec4 v,vec2 f){return vec4(scale(v.xy,f),v.zw);}mat2 rotate2d(float v){float f=cos(v),s=sin(v);return mat2(f,-s,s,f);}mat4 rotate4d(vec3 v,float s){v=normalize(v);float I=sin(s),f=cos(s),c=1.-f;return mat4(c*v.x*v.x+f,c*v.x*v.y-v.z*I,c*v.z*v.x+v.y*I,0.,c*v.x*v.y+v.z*I,c*v.y*v.y+f,c*v.y*v.z-v.x*I,0.,c*v.z*v.x-v.y*I,c*v.y*v.z+v.x*I,c*v.z*v.z+f,0.,0.,0.,0.,1.);}vec2 rotate(vec2 v,float s,vec2 I){return rotate2d(s)*(v-I)+I;}vec2 rotate(vec2 v,float f){return rotate(v,f,vec2(.5));}vec2 rotate(vec2 v,vec2 f){return vec2(dot(v,vec2(-f.y,f)),dot(v,f));}vec3 rotate(vec3 v,float f,vec3 s,vec3 I){return(rotate4d(s,f)*vec4(v-I,1)).xyz+I;}vec3 rotate(vec3 v,float f,vec3 s){return rotate(v,f,s,vec3(0));}vec4 rotate(vec4 v,float f,vec3 s,vec4 I){return rotate4d(s,f)*(v-I)+I;}vec4 rotate(vec4 v,float f,vec3 s){return rotate(v,f,s,vec4(0));}float random(float v){return fract(sin(v)*43758.5453);}float random(vec2 v){return fract(sin(dot(v.xy,vec2(12.9898,78.233)))*43758.5453);}float random(vec3 v){return fract(sin(dot(v.xyz,vec3(70.9898,78.233,32.4355)))*43758.5453123);}float random(vec4 v){return fract(sin(dot(v,vec4(12.9898,78.233,45.164,94.673)))*43758.5453);}\n"+u+"\nvec3 hue(float v){vec3 I=abs(mod(v+vec3(0,1,2)*.33333,1.)*2.-1.);return I*I*(3.-2.*I);}float gamma2linear(float v){return v*v;}vec3 gamma2linear(vec3 v){return v*v;}vec4 gamma2linear(vec4 v){return vec4(gamma2linear(v.xyz),v.w);}\nfloat circleSDF(vec2 v){v-=.5;return length(v)*2.;}float rectSDF(vec2 v,vec2 s,float f){vec2 c=abs(v-.5)*4.2-s+vec2(f);return min(max(c.x,c.y),0.)+length(max(c,0.))-f;}float rectSDF(vec2 v,float s,float f){return rectSDF(v,vec2(s),f);}float rectSDF(vec2 v,vec2 f){v=v*2.-1.;return max(abs(v.x/f.x),abs(v.y/f.y));}float rectSDF(vec2 v,float s){return rectSDF(v,vec2(s));}float fill(float v,float s){return 1.-step(s,v);}\n#if!defined(FNC_SATURATE)&&!defined(saturate)\n#define FNC_SATURATE\n#define saturate(V)clamp(V,0.0,1.0)\n#endif\nfloat stroke(float v){return saturate(step(.5,v+.05)-step(.5,v-.05));}float rect(vec2 v,vec2 f){return fill(rectSDF(v,f),1.);}float rect(vec2 v,float s){return fill(rectSDF(v,vec2(s)),1.);}\nstruct Ray{vec3 origin;vec3 direction;};float rayleigh(const float v){return 3.*(1.+v*v)/(16.*PI);}\nbool atmosphere_intersect(const Ray v,inout float f,inout float s){vec3 I=vec3(0)-v.origin;float r=dot(I,v.direction),c=dot(I,I)-r*r;\n#ifndef ATMOSPHERE_FAST\nif(c>4.12164e13)return false;\n#endif\nfloat S=sqrt(4.12164e13-c);f=r-S;s=r+S;return true;}bool atmosphere_light(const Ray v,inout float f,inout float s){float I=0.,y=5e5;\n#ifndef ATMOSPHERE_FAST\nif(!atmosphere_intersect(v,I,y))return false;\n#endif\nfloat r=0.,c=y/float(4);for(int S=0;S<4;S++){vec3 i=v.origin+v.direction*(r+.5*c);float A=length(i)-6360e3;if(A<0.)return false;f+=exp(-A/7994.0)*c;s+=exp(-A/1200.0)*c;r+=c;}return true;}vec3 atmosphere(const Ray v,vec3 f){float s=0.,y=5e4;\n#ifndef ATMOSPHERE_FAST\nif(!atmosphere_intersect(v,s,y))return vec3(1);\n#endif\nfloat I=y/float(4),c=dot(v.direction,f),x=rayleigh(c),i=max(0.,.4224/((4.+PI)*pow(1.5776-1.52*c,1.5))),r=0.,u=0.;vec3 S=vec3(0),z=vec3(0);float m=0.;for(int A=0;A<4;A++){vec3 T=v.origin+v.direction*(m+.5*I);float p=length(T)-6360e3,d=exp(-p/7994.0)*I,e=exp(-p/1200.0)*I;r+=d;u+=e;Ray a=Ray(T,f);float V=0.,U=0.;if(atmosphere_light(a,V,U)){vec3 Y=vec3(5.5e-6,13.0e-6,22.4e-6)*(r+V)+vec3(21e-6)*1.1*(u+U),n=exp(-Y);S+=d*n;z+=e*n;}m+=I;}return ATMOSPHERE_SUN_POWER*(S*x*vec3(5.5e-6,13.0e-6,22.4e-6)+z*i*vec3(21e-6));}vec3 atmosphere(vec3 v,vec3 f){Ray s=Ray(vec3(0,6360001,0),v);return atmosphere(s,f);}mat3 raymarchCamera(vec3 v,vec3 s,vec3 f){vec3 I=normalize(s-v),c=normalize(cross(I,f));return mat3(c,normalize(cross(c,I)),I);}mat3 raymarchCamera(vec3 v,vec3 s,float f){vec3 I=normalize(s-v),c=normalize(cross(I,vec3(sin(f),cos(f),0)));return mat3(c,cross(c,I),I);}vec3 sharpenFast(sampler2D v,vec2 f,vec2 I){vec3 r=vec3(0);for(int s=0;s<2;s++){float S=float(s)+1.;r+=-1.*texture2D(v,f+vec2(-1,0)*I*S).xyz;r+=-1.*texture2D(v,f+vec2(0,-1)*I*S).xyz;r+=5.*texture2D(v,f+vec2(0)*I*S).xyz;r+=-1.*texture2D(v,f+vec2(0,1)*I*S).xyz;r+=-1.*texture2D(v,f+vec2(1,0)*I*S).xyz;}return r/float(2);}vec3 linear2gamma(vec3 v){return sqrt(v);}vec4 linear2gamma(vec4 v){return vec4(linear2gamma(v.xyz),v.w);}float linear2gamma(float v){return sqrt(v);}vec4 sampleFXAA(sampler2D v,vec2 f,vec2 I){vec3 s=vec3(.299,.587,.114);float r=dot(texture2D(v,f.xy+vec2(-1)*I).xyz,s),y=dot(texture2D(v,f.xy+vec2(1,-1)*I).xyz,s),c=dot(texture2D(v,f.xy+vec2(-1,1)*I).xyz,s),x=dot(texture2D(v,f.xy+vec2(1)*I).xyz,s),i=dot(texture2D(v,f.xy*I).xyz,s);vec2 S=vec2(-r-y+c+x,r+c-y-x);float A=1./(min(abs(S.x),abs(S.y))+max((r+y+c+x)*.03125,1./128.));S=min(vec2(8),max(vec2(-8),S*A))*I;vec4 m=.5*(texture2D(v,f.xy+S*(1./3.-.5))+texture2D(v,f.xy+S*(2./3.-.5))),d=m*.5+.25*(texture2D(v,f.xy+S*-.5)+texture2D(v,f.xy+S*.5));float T=dot(d,vec4(s,0));return T<min(i,min(min(r,y),min(c,x)))||T>max(i,max(max(r,y),max(c,x)))?m:d;}vec2 worldToSpherical(vec3 v){return vec2(atan(v.z,v.x)/PI,acos(v.y)/PI);}float stream(vec2 v,vec2 s,float f){vec2 c=floor(v+s);return 1.-step(f,random(1e2+c*1e-6)+random(c.x)*.5);}vec3 stream(vec2 v){vec3 f=vec3(0);vec2 c=vec2(STREAM_GRID_X,STREAM_GRID_Y),s=v*c;if(STREAM_TYPE<.5)s=s.yx;vec2 I=floor(s)+.1,y=fract(s),r=vec2(u_time*STREAM_SPEED*max(c.x,c.y));r*=vec2(-1,0)*random(1.+I.y);vec2 S=vec2(1,0);f.x+=stream(s-S,r,STREAM_AMOUNT);f.y+=stream(s,r,STREAM_AMOUNT);f.z+=stream(s+S,r,STREAM_AMOUNT);f.xyz*=step(.2,y.y);f=saturate(f);f.xyz*=smoothstep(0.,1.,sin(v.y*PI));return f;}vec3 field(vec2 v){vec3 f=vec3(0);float s=u_time*FIELD_SPEED;vec2 I=floor(vec2(FIELD_GRID,FIELD_GRID*.5)),c=v*I,d=fract(c);float r=noised(vec3(floor(c)/I*3.5+s,s*2.)).x;vec2 S=d;S=rotate(S,HALF_PI*.5);float i=rectSDF(d,vec2(1)),m=r*.5+.5;f+=fill(i,.1)*.5;f+=stroke(S.y)*(m>.25?1.:0.);f+=stroke(S.x)*(m>.5?1.:0.);f=saturate(f);f*=fill(i,.5);f=m>.7?vec3(.9*rect(d,.9)):f;f*=smoothstep(-.75,.75,sin(v.y*PI))*.5;return f;}vec3 enviroment(vec3 v,float s,float f){vec3 I=vec3(0);\n#ifdef ATMOSPHERE_INTENSITY\nvec3 S=normalize(v+vec3(0,ATMOSPHERE_ELEVATION,0));I=atmosphere(S,normalize(LIGHT_POSITION))*ATMOSPHERE_INTENSITY;\n#endif\n\n#if defined(STREAM_INTENSITY)||defined(FIELD_INTENSITY)\nvec3 c=v;\n#ifdef EQUIRECT_TILT\nc=rotate3dX(EQUIRECT_TILT)*c;\n#endif\n\n#ifdef EQUIRECT_ANGLE\nc=rotate3dZ(EQUIRECT_ANGLE)*c;\n#endif\n\n#if defined(FIELD_INTENSITY)\nI=max(I,field(worldToSpherical(c))*FIELD_INTENSITY);\n#elif defined(STREAM_INTENSITY)&&defined(STREAM_AMOUNT)&&defined(STREAM_SPEED)&&defined(STREAM_GRID_X)&&defined(STREAM_GRID_Y)\nI=max(I,stream(worldToSpherical(c))*STREAM_INTENSITY);\n#endif\n\n#endif\n\n#ifdef GROUND_INTENSITY\nfloat r=dot(v,vec3(0,-1,0))*.5+.5;r*=r*r*r*r;r*=max(-v.y,0.);vec3 y=hue(fract(.75+GROUND_HUE*.75));I=max(I,y*GROUND_INTENSITY*r);\n#endif\nreturn I;}vec3 sampleTriplanar(sampler2D v,vec3 f){vec3 c=f*f;return(texture2D(v,f.yz).xyz*c.x+texture2D(v,f.zx).xyz*c.y+texture2D(v,f.xy).xyz*c.z)/(c.x+c.y+c.z);}float pow5(const float v){float I=v*v;return I*I*v;}vec2 pow5(const vec2 v){vec2 I=v*v;return I*I*v;}vec3 pow5(const vec3 v){vec3 I=v*v;return I*I*v;}vec4 pow5(const vec4 v){vec4 I=v*v;return I*I*v;}vec3 schlick(const vec3 v,const float s,const float I){float f=pow5(1.-I);return f+v*(s-f);}vec3 schlick(const vec3 v,const vec3 s,const float I){return v+(s-v)*pow5(1.-I);}float schlick(const float v,const float s,const float I){return v+(s-v)*pow5(1.-I);}\nvec3 interference_gamma_inverse(vec3 v){return 1./1.0*(exp(INTERFERENCE_GAMMA_SCALE*v)-1.);}vec3 interference_fresnel(vec3 v,vec3 f,vec3 I){return schlick(pow((1.-I)/(1.+I),vec3(2)),vec3(1),1.-saturate(1.+dot(v,f)));}vec3 interference_sampleWeights(float v){return vec3((1.-v)*(1.-v),2.8*v*(1.-v),v*v);}vec3 interference_texCubeSampleWeights(float v){vec3 s=interference_sampleWeights(v);return s/dot(s,vec3(1));}vec3 interference_sampleCubeMap(vec3 v,vec3 s,float f,float I){vec3 S=enviroment(s,f,I);return vec3(dot(interference_texCubeSampleWeights(v.x),S),dot(interference_texCubeSampleWeights(v.y),S),dot(interference_texCubeSampleWeights(v.z),S));}vec3 interference_sampleCubeMap(vec3 v,vec3 s,vec3 f,vec3 I,float r,float S){vec3 c=enviroment(s,r,S),y=enviroment(f,r,S),x=enviroment(I,r,S);return vec3(dot(interference_texCubeSampleWeights(v.x),c),dot(interference_texCubeSampleWeights(v.y),y),dot(interference_texCubeSampleWeights(v.z),x));}vec3 interference_attenuation(vec3 v,vec3 s,vec3 f,float I){return.5+.5*cos(INTERFERENCE_THICKNESS_SCALE*I/(v+1.)*dot(s,f));}vec3 interference(vec3 v,vec3 f,float I){const vec3 s=vec3(1.0,0.8,0.6),c=vec3(0.4,0.2,0.0),y=INTERFERENCE_IOR+s*INTERFERENCE_DISPERSION,S=INTERFERENCE_IOR+c*INTERFERENCE_DISPERSION;vec3 r=interference_attenuation(s,f,v,I)*.5,x=interference_attenuation(c,f,v,I)*.5,d=reflect(v,f),i=INTERFERENCE_GAMMA_SCALE*r*interference_sampleCubeMap(s,d,1.,0.),z=INTERFERENCE_GAMMA_SCALE*x*interference_sampleCubeMap(c,d,1.,0.),U=1.-INTERFERENCE_FRESNEL_RATIO+INTERFERENCE_FRESNEL_RATIO*interference_fresnel(v,f,1./y),m=1.-INTERFERENCE_FRESNEL_RATIO+INTERFERENCE_FRESNEL_RATIO*interference_fresnel(v,f,1./S),u=INTERFERENCE_SCALE*interference_gamma_inverse(i*U),a=INTERFERENCE_SCALE*interference_gamma_inverse(z*m),A[6];A[0]=refract(v,f,y.x);A[1]=refract(v,f,y.y);A[2]=refract(v,f,y.z);A[3]=refract(v,f,S.x);A[4]=refract(v,f,S.y);A[5]=refract(v,f,S.z);u+=interference_gamma_inverse(interference_sampleCubeMap(s,A[0],A[1],A[2],1.,0.));a+=interference_gamma_inverse(interference_sampleCubeMap(c,A[3],A[4],A[5],1.,0.));vec3 T=interference_sampleWeights(s.x),n=interference_sampleWeights(s.y),p=interference_sampleWeights(s.z),V=interference_sampleWeights(c.x),P=interference_sampleWeights(c.y),e=interference_sampleWeights(c.z),t=u.x*T+u.y*n+u.z*p+a.x*V+a.y*P+a.z*e;return log(1.0*t+1.)/INTERFERENCE_GAMMA_SCALE;}\n#define ROT_NUM 5\nfloat ang=TAU/float(5);mat2 m=mat2(cos(ang),sin(ang),-sin(ang),cos(ang));float getRot(vec2 v,vec2 f,vec2 I){vec2 c=f;float s=0.;for(int r=0;r<ROT_NUM;r++)s+=dot(texture2D(u_doubleBuffer0,(v+c)*I).xy-.5,c.yx*vec2(1,-1)),c=m*c;return s/float(5)/dot(f,f);}vec3 lensflares(vec2 v,vec2 I){vec2 f=v*length(v);float s=length(v-I);s=pow(s,.1);vec2 r=mix(v,f,-.5);float S=max(.01-pow(length(r+.4*I),2.4),0.)*6.,c=max(.01-pow(length(r+.45*I),2.4),0.)*5.,y=max(.01-pow(length(r+.5*I),2.4),0.)*3.;r=mix(v,f,-.4);float A=max(.01-pow(length(r+.2*I),5.5),0.)*2.,x=max(.01-pow(length(r+.4*I),5.5),0.)*2.,m=max(.01-pow(length(r+.6*I),5.5),0.)*2.;r=mix(v,f,-.5);float d=max(.01-pow(length(r-.3*I),1.6),0.)*6.,z=max(.01-pow(length(r-.325*I),1.6),0.)*3.,U=max(.01-pow(length(r-.35*I),1.6),0.)*5.;return vec3(S+A+d,c+x+z,y+m+U);}void main(){vec4 v=vec4(0,0,0,1);vec2 s=gl_FragCoord.xy,f=1./u_resolution,c=s*f,I=v_texcoord,r=ratio(c,u_resolution)*2.-1.;mat3 S=raymarchCamera(vec4(u_camera,0).xyz,vec3(0),vec3(0,1,0));vec3 i=S*normalize(vec3(r,1));\n#if defined(BUFFER_0)\nvec2 A=vec2(512);f=1./A;float y=1.-circleSDF(I);v.xyz=sharpenFast(u_doubleBuffer0,I,f*10.*y).xyz;\n#elif defined(DOUBLE_BUFFER_0)\nvec2 d=vec2(512);f=1./d;float x=random(u_time);vec2 z=vec2(cos(ang*x),sin(ang*x)),u=I*2.-1.;float e=.7*d.y;e*=e;vec2 T=vec2(0);for(int a=0;a<20;a++){if(dot(z,z)>e)break;vec2 n=z;for(int R=0;R<ROT_NUM;R++)T+=n.yx*getRot(s+n,z,f),n=m*n;z*=2.;}float V=SIMULATION_SPEED;if(u_frame<=24)V=10.;v=texture2D(u_doubleBuffer0,(s+T*vec2(-1,1)*V)*f);v.xy+=.01*u.xy/(dot(u,u)/.1+.3);v.xy=clamp(v.xy,-1.,1.);if(u_frame<=4)v.xy=noised(vec3(c*2.,u_time)).yz;v.w=1.;\n#elif defined(BACKGROUND)\nv.xyz=enviroment(i,1.,0.);\n",h="\n#else\n#ifdef MODEL_VERTEX_NORMAL\nvec2 l=sampleTriplanar(u_buffer0,v_normal).xy;float R=max(l.x,l.y);R=R*.1+.1;v.xyz=interference(i,v_normal,R);v.xyz=gamma2linear(v.xyz);\n#endif\n#endif\ngl_FragColor=v;}";let m="undefined"==typeof tokenData?(()=>{let e="0x";for(let t=64;0<t;--t)e+="0123456789abcdef"[~~(16*Math.random())];return e})():"string"==typeof tokenData?tokenData:tokenData.hash;(()=>{let e=window,t=document,r=e.innerWidth,n=e.innerHeight,i=e.devicePixelRatio;(e=>{const t=~~((e.length-2)/2),r=[];for(let n=0;n<t;n++){const t=2+2*n;r.push(parseInt(e.slice(t,t+2),16))}const n=c(r,1690382925),i=c(r,72970470);a.setUint32(0,n),a.setUint32(4,i)})(m);let s="highp",E=d+"\n#elif defined(POSTPROCESSING)\nv=sampleFXAA(u_scene,c,f);\n#ifdef LIGHT_FLARE_INTENSITY\nvec4 n=vec4(normalize(LIGHT_POSITION),0)*2.,U=u_projectionMatrix*u_viewMatrix*n;U.xy/=U.w;vec3 a=lensflares(r,U.xy);a*=LIGHT_FLARE_INTENSITY;v.xyz+=a;\n#endif\n"+h;(navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/BlackBerry/i)||navigator.userAgent.match(/Windows Phone/i))&&(i=1,s="mediump",E=d+h);const T=new THREE.WebGL1Renderer({canvas:t.querySelector("canvas.emscripten"),precision:s,powerPreference:"high-performance",depth:!1,antialias:!1});T.setPixelRatio(i),T.setSize(r,n),T.autoClearColor=!1;const _=new f(T);_.load(E);const x=new THREE.ShaderMaterial({vertexShader:"\nuniform float   u_time;\n\nvarying vec2    v_texcoord;\nvarying vec3    v_normal;\nvarying vec4    v_position;\n\n#ifndef BUBBLE_SHIFT\n#define BUBBLE_SHIFT 0.0\n#endif\n"+u+"\nvoid main(void) {\nv_position = vec4(position, 1.0);\nv_texcoord = uv;\n\nvec4 n = vec4(0.0);\nvec3 p = (v_position.xyz + 100.0) * 0.5;\nn = noised( vec3(p.xy * 0.8, p.z + u_time * 0.2) ) * 0.06;\nv_position.xyz += n.xyz;\nv_position.x += BUBBLE_SHIFT;\nv_position.y -= BUBBLE_ELEVATION;\n\nv_normal = normalize(normal + n.xyz);\n\ngl_Position = projectionMatrix * modelViewMatrix * v_position;\n}\n",fragmentShader:`#define MODEL_VERTEX_NORMAL\n${E}`,uniforms:_.uniforms,defines:_.defines});let I={};for(let e in l.defines)I[e]=2<l.defines[e].length?v(l.defines[e]):o(...l.defines[e]),0==I[e]&&delete I[e];if("filter"in l)for(let e in l.filter){let t=v(l.filter[e]);if(t in I)for(let r in console.log(t,I[t]),I)r!=t&&l.filter[e].includes(r)&&delete I[r]}for(let e in I)_.defines[e]=1==I[e]?I[e].toString():I[e].toFixed(5);const S=new THREE.Mesh(new THREE.SphereGeometry(1,64,32),x),g=new THREE.Scene,R=new THREE.PerspectiveCamera(45,r/n,.001,200);R.position.x=o(-.25,.25),R.position.y=o(-.25,.25),R.position.z=1,console.log(R.position),R.lookAt(0,0,0);let p=o(2.5,5.5);console.log("Distance:",p),R.position.multiplyScalar(p),g.add(S),console.log(x.defines);let y=0;const A=()=>{y=_.clock.getElapsedTime(),_.time+1/24<y&&_.renderScene(g,R),requestAnimationFrame(A)},N=()=>{t.getElementById("wrapper")&&t.getElementById("wrapper").classList.contains("windowed")?(r=424,n=733):(r=e.innerWidth,n=e.innerHeight),i=e.devicePixelRatio,T.setPixelRatio(i),T.setSize(r,n),_.setSize(r,n),R.aspect=r/n,R.updateProjectionMatrix()};e.addEventListener("resize",N),N(),A()})()}();

document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('resize-btn');
    if (!btn) return;

    const wrapper = document.getElementById('wrapper');
    let isFullscreen = wrapper.classList.contains('fullscreen');

    btn.addEventListener('click', () => {
        isFullscreen = !isFullscreen;

        if (isFullscreen) {
            wrapper.classList.add('fullscreen');
            wrapper.classList.remove('windowed');
            document.body.classList.remove('windowed-mode');
        } else {
            wrapper.classList.remove('fullscreen');
            wrapper.classList.add('windowed');
            document.body.classList.add('windowed-mode');
        }
    });

    // Use ResizeObserver to handle the CSS transition smoothly
    // This fires repeatedly as the element resizes during transition
    const resizeObserver = new ResizeObserver(() => {
        window.dispatchEvent(new Event('resize'));
    });
    resizeObserver.observe(wrapper);
});
